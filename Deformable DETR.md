目录
一、Deformable Convolution原理分析
Deformable DETR 原理分析
Deformable Attention Module
Multi-scale Deformable Attention Module

一、Deformable Convolution原理分析
**Deformable Convolution** 将固定形状的卷积过程改造成了能适应物体形状的可变的卷积过程，从而使结构适应物体形变的能力更强。

传统的CNN卷积核是**固定大小的，只能在固定为位置对固定输入特征进行采样**， 为了解决这个问题，研究人员提出了两种解决思路：

- **使用大量的数据进行训练。** 比如用ImageNet数据集，再在其基础上做翻转等变化来扩展数据集，通俗地说就是通过穷举的方法使模型能够适应各种形状的物体，这种方法收敛较慢而且要设计复杂的网络结构才能达到理想的结果。
- **设计一些特殊的算法来适应形变.** 比如SIFT，目标检测时用滑动窗口法来适应目标在不同位置上的分类也属于这类。

对第一种方法，如果用训练中**没有遇到过的新形状物体 (但同属于一类)来做测试**，由于新形状没有训练过，会造成测试不准确，而且靠数据集来适应形变的**训练过程太耗时** ，网络结构也必须设计的很复杂。

对于第二种方法，如果**物体的形状极其复杂** ，要设计出能适应这种复杂结构的算法就更困难了。

为解决该问题，研究人员提出了 **Deformable Convolution** 方法，它对感受野上的**每一个点加一个偏移量** ，偏移的大小是通过学习得到的 ，**偏移后感受野不再是个正方形，而是和物体的实际形状相匹配**。这么做的好处就是无论物体怎么形变，**卷积的区域始终覆盖在物体形状的周围。**


下图为Deformable Convolution的示意图，a 为原始感受野范围，b ~ c 是对感受野上的添加偏移量后的感受野范围，可以看到叠加偏移量的过程可以模拟出**目标移动、尺寸缩放、旋转等各种形变**

 ![image](https://github.com/icey-zhang/notebook/assets/54712081/8acb7810-b2d3-49b3-a11e-4a882b22e233)

完整的可变性卷积如下图所示，注意上面的卷积用于输出偏移量，该偏移量的长宽和输入特征图的长宽一直，维度是输入的两倍 ， 因为同时输出了x和y方向的偏移量。

![image](https://github.com/icey-zhang/notebook/assets/54712081/7e3d34ef-3b22-4864-a2d7-2411295e09f7)

![image](https://github.com/icey-zhang/notebook/assets/54712081/b34c70e8-a357-499c-af6b-ca6c8006b344)

上图所示为标准卷积和Deformable卷积中的receptive field，采样位置(sampling locations)在整个顶部特征图(左)中是固定的。它们根据可变形卷积中对象的比例和形状进行自适应调整(右)。可以看到经过两层的传统卷积和两层的Deformable卷积的对比结果。左侧的传统卷积单个目标共覆盖了5 x 5=25个采样点，感受野始终是固定不变的方形；右侧的可变形卷积因为感受野的每一个点都有偏移量，造成卷积核在图片上滑动时对应的感受野的点不会重复选择，这意味着会采样9 x 9=81个采样点，比传统卷积更多。

> 显然，传统卷积核在卷积过程中由于会存在重叠，因此输出后的感受野范围小，**而可变性卷积中因为有偏移，不会有重叠，从而感受野范围更大**\

**可变形卷积的优点：**

- 对物体的**形变和尺度建模的能力比较强。**
- **感受野比一般卷积大很多**，因为有偏移的原因，实际上相关实验已经表明了DNN网络很多时候受感受野不足的条件制约；但是一般的空洞卷积空洞是固定的，对不同的数据集不同情况可能最适合的空洞大小是不同的，但是可形变卷积的偏移是可以根据具体数据的情况进行学习的。

**Deformable DETR 原理分析**
我们知道，DETR利用了Transformer通用以及强大的对相关性的建模能力，来取代anchor，proposal等一些手工设计的元素。但是DETR依旧存在2个缺陷：

训练时间极长 ：相比于已有的检测器，DETR需要更久的训练才能达到收敛(500 epochs)，比Faster R-CNN慢了10-20倍。
计算复杂度高 ：发现DETR对小目标的性能很差，现代许多种检测器通常利用多尺度特征，从高分辨率(High Resolution)的特征图中检测小物体。但是高分辨率的特征图会大大提高DETR复杂度。

