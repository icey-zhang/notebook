# Mamba: Linear-Time Sequence Modeling with Selective State Spaces
åŸºç¡€æ¨¡å‹ç°åœ¨ä¸ºæ·±åº¦å­¦ä¹ ä¸­çš„å¤§å¤šæ•°ä»¤äººå…´å¥‹çš„åº”ç”¨æä¾›æ”¯æŒï¼Œå‡ ä¹æ™®éåŸºäº Transformer æ¶æ„åŠå…¶æ ¸å¿ƒæ³¨æ„æ¨¡å—ã€‚å·²ç»å¼€å‘äº†è®¸å¤šæ¬¡äºŒæ¬¡æ—¶é—´æ¶æ„ï¼Œ**ä¾‹å¦‚çº¿æ€§æ³¨æ„åŠ›ã€é—¨æ§å·ç§¯å’Œå¾ªç¯æ¨¡å‹å’Œç»“æ„åŒ–çŠ¶æ€ç©ºé—´æ¨¡å‹ (SSM)**ï¼Œä»¥è§£å†³ Transformer **åœ¨é•¿åºåˆ—ä¸Šçš„è®¡ç®—æ•ˆç‡ä½ä¸‹**ï¼Œä½†å®ƒä»¬å°šæœªæ‰§è¡Œä»¥åŠå¯¹è¯­è¨€ç­‰é‡è¦æ¨¡å¼çš„å…³æ³¨ã€‚æˆ‘ä»¬å‘ç°æ­¤ç±»æ¨¡å‹çš„ä¸€ä¸ªå…³é”®å¼±ç‚¹æ˜¯å®ƒä»¬**æ— æ³•æ‰§è¡ŒåŸºäºå†…å®¹çš„æ¨ç†**ï¼Œå¹¶è¿›è¡Œäº†ä¸€äº›æ”¹è¿›ã€‚é¦–å…ˆï¼Œç®€å•åœ°è®© SSM å‚æ•°ä½œä¸ºè¾“å…¥çš„å‡½æ•°è§£å†³äº†å®ƒä»¬åœ¨**ç¦»æ•£æ¨¡æ€çš„å¼±ç‚¹**ï¼Œå…è®¸æ¨¡å‹æ ¹æ®å½“å‰æ ‡è®°æ²¿åºåˆ—é•¿åº¦ç»´åº¦é€‰æ‹©æ€§åœ°ä¼ æ’­æˆ–å¿˜è®°ä¿¡æ¯ã€‚å…¶æ¬¡ï¼Œå³ä½¿è¿™ç§å˜åŒ–é˜»æ­¢äº†é«˜æ•ˆå·ç§¯çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬åœ¨å¾ªç¯æ¨¡å¼ä¸‹è®¾è®¡äº†ä¸€ç§ç¡¬ä»¶æ„ŸçŸ¥çš„å¹¶è¡Œç®—æ³•ã€‚æˆ‘ä»¬å°†è¿™äº›é€‰æ‹©æ€§ SSM é›†æˆåˆ°ä¸€ä¸ªç®€åŒ–çš„ç«¯åˆ°ç«¯ç¥ç»ç½‘ç»œæ¶æ„ä¸­ï¼Œæ— éœ€æ³¨æ„ç”šè‡³ MLP å— (Mamba)ã€‚Mamba å…·æœ‰å¿«é€Ÿæ¨ç†ï¼ˆæ¯” Transformer é«˜ 5 å€ï¼‰å’Œåºåˆ—é•¿åº¦çš„çº¿æ€§ç¼©æ”¾ï¼Œå…¶æ€§èƒ½åœ¨é«˜è¾¾ç™¾ä¸‡é•¿åºåˆ—çš„çœŸå®æ•°æ®ä¸Šæœ‰æ‰€æé«˜ã€‚ä½œä¸ºé€šç”¨åºåˆ—æ¨¡å‹ä¸»å¹²ï¼ŒMamba åœ¨è¯­è¨€ã€éŸ³é¢‘å’ŒåŸºå› ç»„å­¦ç­‰å¤šç§æ¨¡å¼ä¸Šå®ç°äº†æœ€å…ˆè¿›çš„æ€§èƒ½ã€‚åœ¨è¯­è¨€å»ºæ¨¡æ–¹é¢ï¼Œæˆ‘ä»¬çš„ Mamba-3B æ¨¡å‹åœ¨é¢„è®­ç»ƒå’Œä¸‹æ¸¸è¯„ä¼°ä¸­éƒ½ä¼˜äºç›¸åŒå¤§å°çš„ Transformerï¼Œå¹¶åŒ¹é… Transformer çš„å¤§å°çš„ä¸¤å€ã€‚

èƒŒæ™¯ï¼šS4æ¶æ„
Mambaçš„æ¶æ„ä¸»è¦åŸºäºS4ï¼Œä¸€ç§æœ€æ–°çš„çŠ¶æ€ç©ºé—´æ¨¡å‹ï¼ˆSSMï¼Œstate space modelï¼‰æ¶æ„ã€‚
![image](https://github.com/icey-zhang/notebook/assets/54712081/42e4eeff-86b6-4f85-9fa2-111c1cdd1757)

åœ¨è¾ƒé«˜å±‚æ¬¡ä¸Šï¼ŒS4å­¦ä¹ å¦‚ä½•é€šè¿‡ä¸­é—´çŠ¶æ€ h(t) å°†è¾“å…¥x(t) æ˜ å°„åˆ°è¾“å‡º y(t) ä¸Šã€‚

åœ¨æ­¤ï¼Œç”±äºSSMè¢«è®¾è®¡äºå¾ˆå¥½åœ°å¤„ç†è¿ç»­æ•°æ®ï¼Œä¾‹å¦‚éŸ³é¢‘ã€ä¼ æ„Ÿå™¨æ•°æ®å’Œå›¾åƒï¼Œå› æ­¤xã€yã€t æ˜¯xçš„å‡½æ•°ã€‚

S4é€šè¿‡ä¸‰ä¸ªè¿ç»­å‚æ•°çŸ©é˜µAã€Bå’ŒCå°†å®ƒä»¬äº’è”ï¼Œå…·ä½“å½¢å¼è¡¨ç°ä¸ºä»¥ä¸‹ä¸¤ä¸ªæ–¹ç¨‹ï¼ˆMambaè®ºæ–‡ä¸­çš„1aå’Œ1bï¼‰ï¼š
![image](https://github.com/icey-zhang/notebook/assets/54712081/8886cf36-ca21-453a-91f9-9471b5a18bff)

ç”±äºåœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯å¤„ç†ç¦»æ•£æ•°æ®æ¯”å¦‚æ–‡æœ¬ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å¯¹SSMè¿›è¡Œç¦»æ•£åŒ–ï¼Œé€šè¿‡ä½¿ç”¨ç‰¹æ®Šçš„ç¬¬å››ä¸ªå‚æ•°Î”ï¼Œå°†è¿ç»­å‚æ•°Aã€Bå’ŒCè½¬æ¢ä¸ºç¦»æ•£å‚æ•°ã€‚

ç¦»æ•£åŒ–åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªæ–¹ç¨‹ï¼ˆMambaè®ºæ–‡ä¸­çš„2aå’Œ2bï¼‰æ¥è¡¨ç¤ºSSMï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/a0bfb720-8719-4bcc-babf-fc4e81d2f067)

è¿™äº›æ–¹ç¨‹å½¢æˆä¸€ä¸ªé€’å½’ï¼Œæƒ…å†µç±»ä¼¼äºå’±åœ¨RNNç½‘ç»œä¸­çœ‹åˆ°çš„ä¸€æ ·ã€‚åœ¨æ¯ä¸ªæ­¥éª¤tä¸­ï¼Œæˆ‘ä»¬å°†å‰ä¸€ä¸ªæ—¶é—´æ­¥htâˆ’1çš„éšè—çŠ¶æ€ä¸å½“å‰è¾“å…¥xtç›¸ç»“åˆï¼Œä»¥åˆ›å»ºæ–°çš„éšè—çŠ¶æ€htã€‚

ä¸‹å›¾å±•ç¤ºäº†å®ƒåœ¨é¢„æµ‹å¥å­ä¸­çš„ä¸‹ä¸€ä¸ªå•è¯æ—¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼ˆæˆ‘ä»¬é¢„æµ‹â€œandâ€è·Ÿåœ¨â€œMy name is Jackâ€ä¹‹åï¼‰ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/31fc27f7-02e5-44f0-a21f-02db9335444c)

ä¾æ®ä»¥æ­¤ï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šå°±å¯ä»¥ä½¿ç”¨S4ä½œä¸ºé€’å½’ç¥ç»ç½‘RNNæ¥ä¸€æ¬¡ç”Ÿæˆä¸€ä¸ª tokenã€‚

ç„¶è€Œï¼ŒS4çœŸæ­£é…·çš„åœ°æ–¹åœ¨äºï¼Œä½ ä¹Ÿå¯ä»¥å°†å®ƒç”¨ä½œå·ç§¯ç¥ç»ç½‘ç»œCNNã€‚

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå½“æˆ‘ä»¬æ‰©å±•ä¹‹å‰çš„ç¦»æ•£æ–¹ç¨‹æ¥å°è¯•è®¡ç®—h3æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å‡è®¾xâˆ’1=0ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/5be4d9c0-e2c4-4de2-8183-6925ea3d207e)

è®¡ç®—å‡ºh3åï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ä»£å…¥y3çš„ç­‰å¼ä¸­æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/690f64cc-1fc7-465b-9385-ff1fcd04187b)

ç°åœ¨ï¼Œè¯·æ³¨æ„y3å®é™…ä¸Šå¯ä»¥è®¡ç®—ä¸ºç‚¹ç§¯ï¼Œå…¶ä¸­å³ä¾§å‘é‡æ˜¯æˆ‘ä»¬çš„è¾“å…¥xï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/da058a12-c4e8-464b-87de-c865b86b7143)

ç”±äºå…¶ä¸­ä¸‰ä¸ªç¦»æ•£å‚æ•°Aã€Bå’ŒCéƒ½æ˜¯å¸¸æ•°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é¢„å…ˆè®¡ç®—å·¦ä¾§å‘é‡å¹¶å°†å…¶ä¿å­˜ä¸ºå·ç§¯æ ¸ã€‚è¿™ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§ä½¿ç”¨å·ç§¯è®¡ç®—yçš„ç®€å•æ–¹æ³•ï¼Œå¦‚ä»¥ä¸‹ä¸¤ä¸ªæ–¹ç¨‹æ‰€ç¤ºï¼ˆMambaè®ºæ–‡ä¸­çš„3aå’Œ3bï¼‰ï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/990c1b39-1a63-4205-9217-ee07fea0050b)

åˆ’é‡ç‚¹ï¼šè¿™äº›å¾ªç¯å’Œå·ç§¯å½¢å¼ï¼ˆä½œè€…ç§°ä¹‹ä¸ºâ€œRNNæ¨¡å¼â€å’Œâ€œCNNæ¨¡å¼â€ï¼‰åœ¨æ•°å­¦ä¸Šæ˜¯ç­‰æ•ˆçš„ã€‚

å› æ­¤S4å¯ä»¥æ ¹æ®ä½ éœ€è¦å®ƒæ‰§è¡Œçš„æ“ä½œè¿›è¡Œå˜å½¢ï¼ŒåŒæ—¶è¾“å‡ºæ²¡æœ‰ä»»ä½•å·®å¼‚ã€‚

å½“ç„¶ï¼ŒCNNæ¨¡å¼æ›´é€‚åˆè®­ç»ƒï¼ŒRNNæ¨¡å¼æ›´é€‚åˆæ¨ç†ã€‚

ç¬¬ä¸€ä¸ªä¸»è¦æ€æƒ³ï¼šå¯é€‰æ€§

è¿™éƒ¨åˆ†æˆ‘ä»¬è®¨è®ºMambaå¼•å…¥çš„ç¬¬ä¸€ä¸ªä¸»è¦æ€æƒ³ï¼šå¯é€‰æ€§ã€‚è®©æˆ‘ä»¬å›æƒ³ä¸€ä¸‹å®šä¹‰S4ç¦»æ•£å½¢å¼çš„ä¸¤ä¸ªæ–¹ç¨‹ï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/86298f9f-8b93-4c73-a4df-7e9e9afbe635)

æ³¨æ„ï¼Œåœ¨S4ä¸­ï¼Œæˆ‘ä»¬çš„ç¦»æ•£å‚æ•°ABå’ŒCæ˜¯æ’å®šçš„ã€‚ç„¶è€Œï¼ŒMambaä½¿è¿™äº›å‚æ•°æ ¹æ®è¾“å…¥è€Œå˜åŒ–ã€‚å› æ­¤æˆ‘ä»¬æœ€ç»ˆä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/56671be7-ed49-485b-9bdd-d8effc8cca89)

Mambaä½œè€…ï¼ˆGuå’ŒDaoï¼‰è®¤ä¸ºï¼Œé€‰æ‹©æ€§æˆ–è¾“å…¥ä¾èµ–æ€§å¯¹äºè®¸å¤šä»»åŠ¡éƒ½å¾ˆé‡è¦ã€‚

è€Œæœ¬æ–‡çš„ç§‘æ™®ä½œè€…åˆ™è®¤ä¸ºï¼šå› ä¸ºS4æ²¡æœ‰é€‰æ‹©æ€§ï¼Œæ‰€ä»¥å®ƒè¢«è¿«ä»¥å®Œå…¨ç›¸åŒçš„æ–¹å¼å¤„ç†è¾“å…¥çš„æ‰€æœ‰éƒ¨åˆ†ã€‚

ç„¶è€Œï¼Œå½“æˆ‘ä»¬é¢å¯¹ä¸€å¥è¯æ—¶ï¼Œå…¶ä¸­æœ‰äº›å•è¯ä¸å¯é¿å…åœ°æ¯”å…¶ä»–å•è¯æ›´é‡è¦ã€‚

å°±æ¯”å¦‚ â€œI want to order a hamburger.â€è¿™å¥ã€‚

å¦‚æœæ²¡æœ‰é€‰æ‹©æ€§ï¼ŒS4ä¼šèŠ±è´¹ç›¸åŒçš„â€œç²¾åŠ›â€æ¥å¤„ç†æ¯ä¸ªå•è¯ï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/08fcd197-8cdd-4bcd-ab5d-1aa536436230)


ä½†å¦‚æœæ˜¯ä¸€ä¸ªè¯•å›¾å¯¹è¿™å¥è¯çš„æ„å›¾è¿›è¡Œåˆ†ç±»çš„æ¨¡å‹ï¼Œå®ƒå¯èƒ½ä¼šæƒ³æ›´å¤šåœ°â€œå…³æ³¨â€orderã€hamburgerï¼Œè€Œä¸æ˜¯wantã€toã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè€Œé€šè¿‡ä½¿æ¨¡å‹å‚æ•°æˆä¸ºè¾“å…¥çš„å‡½æ•°ï¼ŒMambaå°±å¯ä»¥åšåˆ°â€œä¸“æ³¨äºâ€è¾“å…¥ä¸­å¯¹äºå½“å‰ä»»åŠ¡æ›´é‡è¦çš„éƒ¨åˆ†ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/a8b8b8da-15bc-4cca-beac-462c01723f39)

ç„¶è€Œï¼Œé€‰æ‹©æ€§ç»™æˆ‘ä»¬å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ã€‚è®©æˆ‘ä»¬å›æƒ³ä¸€ä¸‹ä¹‹å‰è®¡ç®—çš„å·ç§¯æ ¸ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/de9924e7-50b0-4a69-b5ed-8ce74776ec8e)

åœ¨S4ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é¢„å…ˆè®¡ç®—è¯¥å†…æ ¸ã€ä¿å­˜ï¼Œå¹¶å°†å…¶ä¸è¾“å…¥xç›¸ä¹˜ã€‚

è¿™å¾ˆå¥½ï¼Œå› ä¸ºç¦»æ•£å‚æ•°ABå’ŒCæ˜¯æ’å®šçš„ã€‚**ä½†åŒæ ·ï¼Œåœ¨Mambaä¸­ï¼Œè¿™äº›çŸ©é˜µä¼šæ ¹æ®è¾“å…¥è€Œå˜åŒ–ï¼å› æ­¤ï¼Œæˆ‘ä»¬æ— æ³•é¢„è®¡ç®—Kï¼Œä¹Ÿæ— æ³•ä½¿ç”¨CNNæ¨¡å¼æ¥è®­ç»ƒæˆ‘ä»¬çš„æ¨¡å‹ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦é€‰æ‹©æ€§ï¼Œæˆ‘ä»¬å¾—ç”¨RNNæ¨¡å¼è¿›è¡Œè®­ç»ƒã€‚**æ–¹æ³•æ˜¯åˆ é™¤æ–¹ç¨‹3bä»¥è·å¾—â€œæˆå‰§æ€§çš„æ•ˆæœâ€ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/278657c2-e73f-4f99-9e6d-759f6686a61e)

ä½†è¿™ç»™Mambaçš„ä½œè€…å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼š**RNNæ¨¡å¼çš„è®­ç»ƒé€Ÿåº¦éå¸¸æ…¢ã€‚**

å‡å¦‚æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨1000ä¸ªtokençš„åºåˆ—è®­ç»ƒæˆ‘ä»¬çš„æ¨¡å‹ï¼š

CNNæœ¬è´¨ä¸Šä¼šè®¡ç®—å…¶å†…æ ¸å’Œè¾“å…¥å‘é‡ä¹‹é—´çš„ç‚¹ç§¯ï¼Œå¹¶ä¸”å¯ä»¥å¹¶è¡Œæ‰§è¡Œè¿™äº›è®¡ç®—ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒRNNéœ€è¦æŒ‰é¡ºåºæ›´æ–°å…¶éšè—çŠ¶æ€1000æ¬¡ã€‚

è¿™ä¾¿å¯¼è‡´Mambaçš„ä½œè€…æå‡ºäº†ä»–ä»¬çš„ç¬¬äºŒä¸ªä¼Ÿå¤§æ€æƒ³ã€‚

ç¬¬äºŒä¸ªä¸»è¦æ€æƒ³ï¼šæ— éœ€å·ç§¯çš„å¿«é€Ÿè®­ç»ƒ
Mambaå¯ä»¥åœ¨RNNæ¨¡å¼ä¸‹è¿›è¡Œéå¸¸éå¸¸å¿«é€Ÿçš„è®­ç»ƒã€‚

åœ¨æŸä¸ªæ—¶åˆ»ï¼Œå®ƒä»¬çš„é€’å½’ä¸æ‰«æç®—æ³•ï¼ˆä¹Ÿç§°ä¸ºå‰ç¼€å’Œï¼Œprefix sumï¼‰éå¸¸ç›¸ä¼¼ã€‚

è¦è®¡ç®—å‰ç¼€å’Œï¼Œæˆ‘ä»¬éœ€è¦è·å–ä¸€ä¸ªè¾“å…¥æ•°ç»„ [x1ï¼Œx2ï¼Œâ€¦ ï¼Œxn] ï¼Œå¹¶è¿”å›ä¸€ä¸ªè¾“å‡ºæ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯è¯¥é¡¹ç›®åŠå…¶ä¹‹å‰é¡¹ç›®çš„æ€»å’Œã€‚

æ¢å¥è¯è¯´ï¼Œè¾“å‡ºçš„ç¬¬ä¸€ä¸ªå…ƒç´ å°†ä¸ºx1 ï¼Œç¬¬äºŒä¸ªå…ƒç´ å°†ä¸º[x1+[x2 ï¼Œä¾æ­¤ç±»æ¨ã€‚ä¸€ä¸ªä¾‹å­ï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/dd292cd1-4cae-47fb-889d-cd0e71476a5b)


ç°åœ¨æˆ‘ä»¬ç”»å‡ºRNNæ¨¡å¼ä¸‹æ›´æ–°Mambaéšè—çŠ¶æ€çš„æµç¨‹ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/e30cf5f6-ef25-4392-ac6c-7fff6f63296e)


ç­‰ç­‰â€¦â€¦ï¼Œå¦‚æœæˆ‘ä»¬å¿…é¡»å½¢å¼åŒ–å‰ç¼€å’Œï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶å†™æˆä»¥ä¸‹ç­‰å¼ï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/478f6528-fdc9-4761-83ef-a86a1c85464a)


è¯¥æ–¹ç¨‹å½¢æˆä¸€ä¸ªé€’å½’ï¼šåœ¨æ¯ä¸€æ­¥ï¼Œæˆ‘ä»¬é€šè¿‡å°†å…ˆå‰å­˜å‚¨çš„å€¼æ·»åŠ åˆ°å½“å‰è¾“å…¥æ¥è®¡ç®—æ–°å€¼ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬å†æ¬¡çœ‹çœ‹æ›´æ–°ä¹‹åMambaéšè—çŠ¶æ€çš„å¾ªç¯ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/9efad322-4c08-47ff-a9ce-cc73ea4d59de)


è¿™ä¸¤ä¸ªç­‰å¼çœŸçš„éå¸¸éå¸¸ç›¸ä¼¼æœ‰ä¹ˆæœ‰ï¼

è€Œæœ€é…·çš„åœ°æ–¹åˆæ¥äº†ï¼šè™½ç„¶è®¡ç®—å‰ç¼€å’Œæœ¬è´¨ä¸Šçœ‹èµ·æ¥ä¼¼ä¹æ˜¯é¡ºåºçš„ï¼Œä½†æˆ‘ä»¬å®é™…ä¸Šæ‹¥æœ‰ç”¨äºæ­¤ä»»åŠ¡çš„é«˜æ•ˆå¹¶è¡Œç®—æ³•ï¼

åœ¨ä¸‹å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ­£åœ¨è¿è¡Œçš„å¹¶è¡Œå‰ç¼€å’Œç®—æ³•ï¼Œå…¶ä¸­æ¯æ¡å‚ç›´çº¿ä»£è¡¨æ•°ç»„ä¸­çš„ä¸€é¡¹ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/dcee1e92-736f-4a7f-860a-65acede36c17)


èŠ±ä¸€ç‚¹æ—¶é—´æ‹ä¸€ä¸‹è¿™ä¸ªç®—æ³•ï¼š

é€‰æ‹©ä»»ä½•å‚ç›´çº¿ï¼Œä»é¡¶éƒ¨å¼€å§‹ï¼Œç„¶åå‘ä¸‹ç§»åŠ¨ï¼Œå°†æ¯ä¸ªåŠ æ³•è¿½æº¯åˆ°æ•°ç»„çš„å‰å‡ ä¸ªé¡¹ç›®ã€‚å½“ä½ åˆ°è¾¾åº•éƒ¨æ—¶ï¼Œåº”è¯¥åœ¨è¡Œçš„å·¦ä¾§çœ‹åˆ°æ‰€æœ‰é¡¹ç›®çš„æ€»å’Œã€‚

ä¾‹å¦‚ï¼Œåœ¨ç¬¬ä¸€ä¸ªå…ƒç´ æ·»åŠ åˆ°å¼€å¤´çš„ç¬¬äºŒä¸ªå…ƒç´ ä¹‹åï¼Œæ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ åœ¨æœ«å°¾æ¥æ”¶äº†ç¬¬äºŒä¸ªå…ƒç´ çš„æ·»åŠ å€¼ã€‚ç»“æœï¼Œå½“å¹¶è¡Œæ‰«æå®Œæˆæ—¶ï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ åŒ…å«ç¬¬ä¸€ã€ç¬¬äºŒå’Œç¬¬ä¸‰å…ƒç´ çš„æ€»å’Œã€‚

å¦‚æœæˆ‘ä»¬åœ¨æ²¡æœ‰å¹¶è¡Œæ€§çš„å•çº¿ç¨‹ä¸­è¿è¡Œè¯¥ç®—æ³•ï¼Œåˆ™æ¯”ä»…æŒ‰é¡ºåºå°†å€¼ç›¸åŠ æ‰€éœ€çš„æ—¶é—´è¦é•¿ã€‚ä½†GPUæ‹¥æœ‰å¤§é‡å¤„ç†å™¨ï¼Œå¯ä»¥è¿›è¡Œé«˜åº¦å¹¶è¡Œè®¡ç®—ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤§çº¦O(logn) æ—¶é—´å†…è®¡ç®—æ­¤å‰ç¼€å’Œï¼ˆæˆ–æ‰«æï¼‰æ“ä½œï¼

å› æ­¤ï¼ŒMambaçš„ä½œè€…æ„è¯†åˆ°ï¼Œå¦‚æœä»–ä»¬æƒ³åœ¨RNNæ¨¡å¼ä¸‹é«˜æ•ˆè®­ç»ƒï¼Œä»–ä»¬å¯èƒ½å¯ä»¥ç”¨å¹¶è¡Œæ‰«æã€‚

ä½†ç”±äºPyTorchç›®å‰æ²¡æœ‰æ‰«æå®ç°ï¼ŒMambaçš„ä½œè€…è‡ªå·±ç¼–å†™äº†ä¸€ä¸ªâ€”â€”ä½†ï¼Œç»“æœå¹¶ä¸å¥½ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/a4147293-85a5-49d4-a617-4be5a54de6ad)


åœ¨ä¸Šå›¾ä¸­ï¼Œå¤§å®¶å¯ä»¥çœ‹åˆ°ä»–ä»¬åŸºäºPyTorchçš„æ‰«æå®ç°ï¼ˆç»¿è‰²ï¼‰æ€»æ˜¯æ…¢äºFlashAttention-2ï¼ˆè“è‰²ï¼‰ï¼ŒFlashAttention-2æ˜¯å¯ç”¨â€œç²¾ç¡®æ³¨æ„åŠ›â€çš„æœ€å¿«å®ç°ã€‚

å°½ç®¡å½“åºåˆ—é•¿åº¦ä¸º128000ä¸ªtokenæ—¶ï¼Œæ‰«æä¼¼ä¹åœ¨è¿è¡Œæ—¶èµ¶ä¸Šï¼Œä½†è¿˜æ˜¯è€—å°½äº†å†…å­˜ã€‚

ä¸ºäº†è®©Mambaå˜å¾—å®ç”¨ï¼Œå®ƒéœ€è¦æ›´å¿«ã€‚è¿™è®©Mambaçš„ä½œè€…çœ‹åˆ°äº†Daoä¹‹å‰å…³äºFlashAttentionçš„å·¥ä½œï¼Œä»è€Œè§£å†³äº†é—®é¢˜ã€‚

ç”±äºç¯‡å¹…æ‰€é™ï¼Œåœ¨æ­¤æˆ‘ä»¬çœç•¥äº†åŸæ–‡ä¸­FlashAttentionçš„åŸç†ä»‹ç»éƒ¨åˆ†ï¼ˆReview: FlashAttentionï¼‰ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥æŸ¥çœ‹åŸåš/FlashAttentionåŸè®ºæ–‡ï¼Œæˆ–è€…æˆ‘ä»¬ä¹‹å‰çš„ä¸€ç¯‡[åŸç†ä»‹ç»æ–‡ç« ](https://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzIzNjc1NzUzMw%3D%3D%26mid%3D2247686895%26idx%3D3%26sn%3D18e1c3fd5db81cf3c4a72c223b6344f6%26chksm%3De8dead9ddfa9248b30ed2f3f961659ff84c1e7d47aa35a5fa78e9c5c8f28fc61269935c47fc3%26scene%3D21%23wechat_redirect)ã€‚

Back to Mamba
è¿˜æ˜¯åŸºäºä¸Šä¸€å¼ å¯¹æ¯”å›¾ã€‚

äº‹å®è¯æ˜ï¼Œå¦‚æœåœ¨è®¡ç®—æ‰«ææ—¶é‡‡ç”¨ç›¸åŒçš„å†…å­˜æ„ŸçŸ¥å¹³é“ºæ–¹æ³•ï¼Œåˆ™å¯ä»¥å¤§å¤§åŠ å¿«é€Ÿåº¦ã€‚

é€šè¿‡è¿™ç§ä¼˜åŒ–ï¼ŒMambaï¼ˆçº¢è‰²ï¼‰ç°åœ¨åœ¨æ‰€æœ‰åºåˆ—é•¿åº¦ä¸Šéƒ½æ¯” FlashAttention-2ï¼ˆè“è‰²ï¼‰æ›´å¿«ã€‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/f283ef4b-d3c5-4b50-aa78-9789f8df8a16)


è¿™äº›ç»“æœè¡¨æ˜ï¼Œå°±é€Ÿåº¦è€Œè¨€ï¼ŒMambaæ˜¯å®ç”¨çš„ï¼Œå…¶è¿è¡Œé€Ÿåº¦æ¯”æœ€å¿«çš„Transformerè¿˜è¦å¿«ã€‚ä½†å®ƒåœ¨è¯­è¨€å»ºæ¨¡æ–¹é¢æœ‰ä»€ä¹ˆæ“…é•¿çš„åœ°æ–¹å—ï¼Ÿ

Mambaä½œè€…åœ¨æ¶‰åŠè¯­è¨€ã€åŸºå› ç»„å­¦å’ŒéŸ³é¢‘çš„è®¸å¤šåºåˆ—å»ºæ¨¡ä»»åŠ¡ä¸Šå¯¹Mambaè¿›è¡Œäº†è¯„ä¼°ã€‚

ç»“æœçœ‹èµ·æ¥å¾ˆé…·ï¼šMambaåœ¨å¯¹äººç±»åŸºå› ç»„é¡¹ç›®çš„DNAå’Œé’¢ç´éŸ³ä¹æ•°æ®é›†çš„éŸ³é¢‘è¿›è¡Œå»ºæ¨¡æ—¶å»ºç«‹äº†æœ€å…ˆè¿›çš„æ€§èƒ½ã€‚

ç„¶è€Œï¼Œè®©å¾ˆå¤šäººå…´å¥‹çš„æ˜¯è¯­è¨€ä»»åŠ¡ä¸Šçš„ç»“æœã€‚è®¸å¤šå…³äºMambaçš„åœ¨çº¿è®¨è®ºéƒ½é›†ä¸­åœ¨ä¸‹å›¾ä¸­ï¼š

![image](https://github.com/icey-zhang/notebook/assets/54712081/9cdc4bec-39de-420f-aaac-ff3f759705ac)


æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¨¡å‹å¤§å°å‘å³å¢åŠ ï¼Œè¯­è¨€å»ºæ¨¡æ€§èƒ½åˆ™éšç€è¿›ä¸€æ­¥å‘ä¸‹è€Œæé«˜ã€‚

è¿™æ„å‘³ç€æœ€å¥½çš„æ¨¡å‹åº”è¯¥ä½äºå·¦ä¾§ï¼šä½“ç§¯å°ï¼ˆå› æ­¤é€Ÿåº¦å¿«ï¼‰ï¼Œå¹¶ä¸”éå¸¸æ“…é•¿å»ºæ¨¡è¯­è¨€ã€‚

ç”±äºMambaä½œè€…éƒ½æ˜¯å­¦è€…ï¼Œæä¸æ¥æ•°åƒä¸ªGPUæ¥è®­ç»ƒGPT-4å¤§å°çš„æ¨¡å‹ï¼Œå› æ­¤å®éªŒæ˜¯é€šè¿‡è®­ç»ƒä¸€å †è¾ƒå°çš„æ¨¡å‹ï¼ˆå¤§çº¦125Måˆ°1.3Bå‚æ•°ï¼‰æ¥è¿›è¡Œæ¯”è¾ƒçš„ã€‚

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç»“æœçœ‹èµ·æ¥éå¸¸æœ‰å¸Œæœ›ã€‚ä¸å…¶ä»–ç±»ä¼¼å°ºå¯¸çš„æ¨¡å‹ç›¸æ¯”ï¼ŒMambaä¼¼ä¹æ˜¯æœ€æ“…é•¿å»ºæ¨¡è¯­è¨€çš„ã€‚

https://zhuanlan.zhihu.com/p/683978639

**https://blog.csdn.net/v_JULY_v/article/details/134923301**

## ç¬¬ä¸‰éƒ¨åˆ† Mambaçš„ä¸‰å¤§åˆ›æ–°
mamba(å…¶å¯¹åº”è®ºæ–‡ä¸ºï¼šMamba: Linear-Time Sequence Modeling with Selective State Spacesï¼Œè¿™æ˜¯å…¶å¯¹åº”çš„GitHubä»£ç åœ°å€)ï¼Œåœ¨è¯­è¨€ã€éŸ³é¢‘ã€DNAåºåˆ—æ¨¡æ€ä¸Šéƒ½å®ç°SOTAï¼Œåœ¨æœ€å—å…³æ³¨çš„è¯­è¨€ä»»åŠ¡ä¸Šï¼ŒMamba-3Bè¶…è¶ŠåŒç­‰è§„æ¨¡çš„Transformerï¼Œä¸ä¸¤å€å¤§çš„TransformeråŒ¹æ•Œï¼Œå¹¶ä¸”ç›¸å…³ä»£ç ã€é¢„è®­ç»ƒæ¨¡å‹checkpointéƒ½å·²å¼€æº

ç®€è¨€ä¹‹ï¼ŒMambaæ˜¯ä¸€ç§çŠ¶æ€ç©ºé—´æ¨¡å‹(SSM)ï¼Œå»ºç«‹åœ¨æ›´ç°ä»£çš„é€‚ç”¨äºæ·±åº¦å­¦ä¹ çš„ç»“æ„åŒ–SSM (ç®€ç§°S6)åŸºç¡€ä¸Šï¼Œä¸ç»å…¸æ¶æ„RNNæœ‰ç›¸ä¼¼ä¹‹å¤„

### 3.1 Mamba = æœ‰é€‰æ‹©å¤„ç†ä¿¡æ¯ + ç¡¬ä»¶æ„ŸçŸ¥ç®—æ³• + æ›´ç®€å•çš„SSMæ¶æ„
ä¸å…ˆå‰çš„ç ”ç©¶ç›¸æ¯”ï¼ŒMambaä¸»è¦æœ‰ä¸‰ç‚¹åˆ›æ–°ï¼š

**1.å¯¹è¾“å…¥ä¿¡æ¯æœ‰é€‰æ‹©æ€§å¤„ç†(Selection Mechanism)**

**2.ç¡¬ä»¶æ„ŸçŸ¥çš„ç®—æ³•(Hardware-aware Algorithm)**
è¯¥ç®—æ³•é‡‡ç”¨â€œå¹¶è¡Œæ‰«æç®—æ³•â€è€Œéâ€œå·ç§¯â€æ¥è¿›è¡Œæ¨¡å‹çš„å¾ªç¯è®¡ç®—(ä½¿å¾—ä¸ç”¨CNNä¹Ÿèƒ½å¹¶è¡Œè®­ç»ƒ)ï¼Œä½†ä¸ºäº†å‡å°‘GPUå†…å­˜å±‚æ¬¡ç»“æ„ä¸­ä¸åŒçº§åˆ«ä¹‹é—´çš„IOè®¿é—®ï¼Œå®ƒæ²¡æœ‰å…·ä½“åŒ–æ‰©å±•çŠ¶æ€
å½“ç„¶ï¼Œè¿™ç‚¹ä¹Ÿæ˜¯å—åˆ°äº†S5(Simplified State Space Layers for Sequence Modeling)çš„å¯å‘

**3.æ›´ç®€å•çš„æ¶æ„**
å°†SSMæ¶æ„çš„è®¾è®¡ä¸transformerçš„MLPå—åˆå¹¶ä¸ºä¸€ä¸ªå—(combining the design of prior SSM architectures with the MLP block of Transformers into a single block)ï¼Œæ¥ç®€åŒ–è¿‡å»çš„æ·±åº¦åºåˆ—æ¨¡å‹æ¶æ„ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªåŒ…å«selective state spaceçš„æ¶æ„è®¾è®¡

#### 3.1.1 é€‰æ‹©æ€§çŠ¶æ€ç©ºé—´æ¨¡å‹ï¼šä»S4åˆ°S6
ä½œè€…è®¤ä¸ºï¼Œåºåˆ—å»ºæ¨¡çš„ä¸€ä¸ªåŸºç¡€é—®é¢˜æ˜¯æŠŠä¸Šä¸‹æ–‡å‹ç¼©æˆæ›´å°çš„çŠ¶æ€(We argue that a fundamental problem of sequence modeling is compressing context into a smaller state)ï¼Œä»è¿™ä¸ªè§’åº¦æ¥çœ‹

> transformerçš„æ³¨æ„åŠ›æœºåˆ¶è™½ç„¶æœ‰æ•ˆæœä½†æ•ˆç‡ä¸ç®—å¾ˆé«˜ï¼Œæ¯•ç«Ÿå…¶éœ€è¦æ˜¾å¼åœ°å­˜å‚¨æ•´ä¸ªä¸Šä¸‹æ–‡(storing the entire contextï¼Œä¹Ÿå°±æ˜¯KVç¼“å­˜)ï¼Œç›´æ¥å¯¼è‡´è®­ç»ƒå’Œæ¨ç†æ¶ˆè€—ç®—åŠ›å¤§
å¥½æ¯”ï¼ŒTransformerå°±åƒäººç±»æ¯å†™ä¸€ä¸ªå­—ä¹‹å‰ï¼Œéƒ½æŠŠå‰é¢çš„æ‰€æœ‰å­—+è¾“å…¥éƒ½å¤ä¹ ä¸€éï¼Œæ‰€ä»¥å†™çš„æ…¢
> RNNçš„æ¨ç†å’Œè®­ç»ƒæ•ˆç‡é«˜ï¼Œä½†æ€§èƒ½å®¹æ˜“å—åˆ°å¯¹ä¸Šä¸‹æ–‡å‹ç¼©ç¨‹åº¦çš„é™åˆ¶
On the other hand, recurrent models are efficient because they have a finite state, implying constant-time inference and linear-time training. However, their effectiveness is limited by how well this state has compressed the context.

å¥½æ¯”ï¼ŒRNNæ¯æ¬¡åªå‚è€ƒå‰é¢å›ºå®šçš„å­—æ•°(ä»”ç»†ä½“ä¼šè¿™å¥è¯ï¼šWhen generating the output, the RNN only needs to consider the previous hidden state and current input. It prevents recalculating all previous hidden states which is what a Transformer would do)ï¼Œå†™çš„å¿«æ˜¯å¿«ï¼Œä½†å®¹æ˜“å¿˜æ‰æ›´å‰é¢çš„å†…å®¹

> è€ŒSSMçš„é—®é¢˜åœ¨äºå…¶ä¸­çš„çŸ©é˜µA B Cä¸éšè¾“å…¥ä¸åŒè€Œä¸åŒï¼Œå³æ— æ³•é’ˆå¯¹ä¸åŒçš„è¾“å…¥é’ˆå¯¹æ€§çš„æ¨ç†ï¼Œè¯¦è§ä¸Šæ–‡çš„2.4èŠ‚

![image](https://github.com/icey-zhang/notebook/assets/54712081/13c84216-0b2c-43f6-8a75-3fc56470d9cb)

æœ€ç»ˆï¼ŒMambaçš„è§£å†³åŠæ³•æ˜¯ï¼Œç›¸æ¯”SSMå‹ç¼©æ‰€æœ‰å†å²è®°å½•ï¼Œmambaè®¾è®¡äº†ä¸€ä¸ªç®€å•çš„é€‰æ‹©æœºåˆ¶ï¼Œé€šè¿‡â€œå‚æ•°åŒ–SSMçš„è¾“å…¥â€ï¼Œè®©æ¨¡å‹å¯¹ä¿¡æ¯æœ‰é€‰æ‹©æ€§å¤„ç†ï¼Œä»¥ä¾¿å…³æ³¨æˆ–å¿½ç•¥ç‰¹å®šçš„è¾“å…¥
è¿™æ ·ä¸€æ¥ï¼Œæ¨¡å‹èƒ½å¤Ÿè¿‡æ»¤æ‰ä¸é—®é¢˜æ— å…³çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥é•¿æœŸè®°ä½ä¸é—®é¢˜ç›¸å…³çš„ä¿¡æ¯
å¥½æ¯”ï¼ŒMambaæ¯æ¬¡å‚è€ƒå‰é¢æ‰€æœ‰å†…å®¹çš„ä¸€ä¸ªæ¦‚æ‹¬ï¼Œè¶Šå¾€åå†™å¯¹å‰é¢å†…å®¹æ¦‚æ‹¬å¾—è¶Šç‹ ï¼Œä¸¢æ‰ç»†èŠ‚ã€ä¿ç•™å¤§æ„

ä¸ºæ–¹ä¾¿å¤§å®¶å¯¹æ¯”ï¼Œæˆ‘å†ç”¨å¦‚ä¸‹è¡¨æ ¼æ€»ç»“ä¸‹å„ä¸ªæ¨¡å‹çš„æ ¸å¿ƒç‰¹ç‚¹
![image](https://github.com/icey-zhang/notebook/assets/54712081/3dd67973-84fa-4e6d-aa89-8da6f81ab74b)

æ€»ä¹‹ï¼Œåºåˆ—æ¨¡å‹çš„æ•ˆç‡ä¸æ•ˆæœçš„æƒè¡¡ç‚¹åœ¨äºå®ƒä»¬å¯¹çŠ¶æ€çš„å‹ç¼©ç¨‹åº¦ï¼š

é«˜æ•ˆçš„æ¨¡å‹å¿…é¡»æœ‰ä¸€ä¸ªå°çš„çŠ¶æ€(æ¯”å¦‚RNNæˆ–S4)
è€Œæœ‰æ•ˆçš„æ¨¡å‹å¿…é¡»æœ‰ä¸€ä¸ªåŒ…å«æ¥è‡ªä¸Šä¸‹æ–‡çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯çš„çŠ¶æ€(æ¯”å¦‚transformer)
è€Œmambaä¸ºäº†å…¼é¡¾æ•ˆç‡å’Œæ•ˆæœï¼Œé€‰æ‹©æ€§çš„å…³æ³¨å¿…é¡»å…³æ³¨çš„ã€è¿‡æ»¤æ‰å¯ä»¥å¿½ç•¥çš„

![image](https://github.com/icey-zhang/notebook/assets/54712081/5beeed44-c4de-4d7b-b7b1-56ec28e4c72b)

##### 3.1.1.1 mambaå‰èº«S4çš„4ä¸ªå‚æ•°çš„ä¸éšè¾“å…¥ä¸åŒè€Œä¸åŒ
é¦–å…ˆï¼Œåœ¨å…¶å‰èº«S4ä¸­ï¼Œå…¶æœ‰4ä¸ªå‚æ•°(âˆ†, A, B, C)

![image](https://github.com/icey-zhang/notebook/assets/54712081/880af0f4-6016-444d-819e-81fadbc59ac1)

ä¸”å®ƒä»¬ä¸éšè¾“å…¥å˜åŒ–(å³ä¸è¾“å…¥æ— å…³)ï¼Œè¿™äº›å‚æ•°æ§åˆ¶äº†ä»¥ä¸‹ä¸¤ä¸ªé˜¶æ®µ


![image](https://github.com/icey-zhang/notebook/assets/54712081/ee230256-71cd-457b-b256-42baa722c8b0)


ç¬¬ä¸€é˜¶æ®µ(1a 1b)ï¼Œé€šå¸¸é‡‡ç”¨å›ºå®šå…¬å¼å’Œï¼Œå°†â€œè¿ç»­å‚æ•°â€è½¬åŒ–ä¸ºâ€œç¦»æ•£å‚æ•°â€ï¼Œå…¶ä¸­ç§°ä¸ºç¦»æ•£åŒ–è§„åˆ™ï¼Œä¸”å¯ä»¥ä½¿ç”¨å¤šç§è§„åˆ™æ¥å®ç°è¿™ä¸€è½¬æ¢
The first stage transforms the â€œcontinuous parametersâ€ (âˆ†, A, B) to â€œdiscrete parametersâ€ (A, B) through fixed formulas A = ğ‘“ğ´(âˆ†, A) and B = ğ‘“ğµ(âˆ†, A, B), where the pair (ğ‘“ğ´, ğ‘“ğµ) is called a discretization rule

ä¾‹å¦‚ä¸‹è¿°æ–¹ç¨‹ä¸­å®šä¹‰çš„é›¶é˜¶ä¿æŒ(ZOH)
Various rules can be used such as the zero-order hold (ZOH) defined in equation (4).

ç¬¬äºŒé˜¶æ®µ(2a 2bï¼Œå’Œ3a 3b)ï¼Œåœ¨å‚æ•°ç”±å˜æ¢ä¸ºåï¼Œæ¨¡å‹å¯ä»¥ç”¨ä¸¤ç§æ–¹å¼è®¡ç®—ï¼Œå³çº¿æ€§é€’å½’(2)æˆ–å…¨å±€å·ç§¯(3)
After the parameters have been transformed from (âˆ†, A, B, C) â†¦ (A, B, C), the model can be computed in two ways, either as a linear recurrence (2) or a global convolution (3)

å¦‚ä¹‹å‰æ‰€è¯´çš„
  æ¨¡å‹é€šå¸¸ä½¿ç”¨å·ç§¯æ¨¡å¼(3)å¯ä»¥è¿›è¡Œé«˜æ•ˆçš„å¹¶è¡ŒåŒ–è®­ç»ƒã€Œ å…¶ä¸­æ•´ä¸ªè¾“å…¥åºåˆ—æå‰çœ‹åˆ°ï¼Œä¸ºä½•å¯ä»¥åšé«˜æ•ˆçš„å¹¶è¡ŒåŒ–å‘¢ï¼Œå› ä¸ºè¯¥æ¨¡å¼èƒ½å¤Ÿç»•è¿‡çŠ¶æ€è®¡ç®—ï¼Œå¹¶å®ç°ä»…åŒ…å«(B, L, D)çš„å·ç§¯æ ¸(3a)ï¼Œå³Thus the more efficient convolution mode wasintroduced which could bypass the state computation and materializes a convolution kernel (3a) of only (ğ™±, ğ™», ğ™³)ã€
  å¹¶åˆ‡æ¢åˆ°å¾ªç¯æ¨¡å¼(2)ä»¥é«˜æ•ˆçš„è‡ªå›å½’æ¨ç†(å…¶ä¸­è¾“å…¥æ¯æ¬¡åªçœ‹åˆ°ä¸€ä¸ªæ—¶é—´æ­¥)
the model uses the convolutional mode (3) for efficient parallelizable training (where the whole input sequence is seen ahead of time), and switched into recurrent mode (2) for efficient autoregressive inference (wheret he inputs are seen one timestep at a time

##### 3.1.1.2 S4ä¸­ä¸‰ä¸ªçŸ©é˜µçš„ç»´åº¦è¡¨ç¤ºã€ç»´åº¦å˜åŒ–
å…¶æ¬¡ï¼Œå†å›é¡¾ä¸€ä¸‹ï¼Œé€šè¿‡ä¹‹å‰çš„è®²è§£ï¼Œå¯çŸ¥çŸ©é˜µéƒ½å¯ä»¥ç”±ä¸ªæ•°å­—è¡¨ç¤º(the Aâˆˆâ„ğ‘Ã—ğ‘, Bâˆˆâ„ğ‘Ã—1 , C âˆˆ â„1Ã—ğ‘ matrices can all be represented by ğ‘ numbers.)

![image](https://github.com/icey-zhang/notebook/assets/54712081/e417e85f-ec66-4e84-8c07-abadd528442e)

1.ä½†ä¸ºäº†å¯¹æ‰¹é‡å¤§å°ä¸ºBã€é•¿åº¦ä¸ºL(æ³¨æ„ï¼ŒN <<Lï¼Œæ¯”å¦‚ç±»ä¼¼ä¸Šæ–‡ä¸¾çš„ä¾‹å­ä¸­ï¼ŒN = 64 L=10000)ã€å…·æœ‰Dä¸ªé€šé“(è™½ç„¶åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œæ¯ä¸ªtokençš„ç»´åº¦è®¾å®šçš„1ï¼Œæ¯”å¦‚æ‹¿ ä¸€ä¸ª 64 Ã— 64ç»´çš„çŸ©é˜µA å»è®° 10000 Ã— 1ç»´çš„æ•°å­—ï¼Œä½†å®é™…ä¸Šï¼Œç»å¸¸ä¼šé‡åˆ°ä¸€ä¸ªtokenä¸æ­¢ä¸€ä¸ªç»´åº¦çš„ï¼Œæ¯”å¦‚é¢œè‰²ä¾¿æœ‰R G Bä¸‰ä¸ªé€šé“ï¼Œå³embeddingçš„dimensionæ˜¯D )çš„è¾“å…¥åºåˆ—è¿›è¡Œæ“ä½œã€Œæ€»ä¹‹ï¼Œåˆ™æ˜¯è¾“å…¥å’Œè¾“å‡ºï¼Œå’Œ Transformer é‡Œé¢ä¸€æ ·, ä»–ä»¬çš„å¤§å°æ˜¯ (batch size B x sequence length L x embedding dim D)ã€

![image](https://github.com/icey-zhang/notebook/assets/54712081/ee803c22-28b7-478a-b777-cd952fb631b2)


Mamba çš„å¤„ç†æ–¹å¼æ˜¯ï¼Œç»™è¿™ D ä¸ª dimensionçš„æ¯ä¸ª dimension éƒ½æä¸€ä¸ªç‹¬ç«‹çš„ SSMï¼Œå³SSMè¢«ç‹¬ç«‹åœ°åº”ç”¨äºæ¯ä¸ªé€šé“(To operate over an input sequence ğ‘¥ of batch size ğµ and length ğ¿ with ğ· channels, the SSM is applied independently to each channel)

2.è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆä¸‹å›¾ä¸­çš„Aã€Bã€Cä¸‰ä¸ªçŸ©é˜µçš„ç¬¬ä¸€ä¸ªç»´åº¦æ˜¯éƒ½æ˜¯ D

![image](https://github.com/icey-zhang/notebook/assets/54712081/f7776191-ea10-4ffe-889f-12031c31c817)


è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯ä¸ªè¾“å…¥çš„æ€»éšè—çŠ¶æ€å…·æœ‰DNç»´ï¼Œåœ¨åºåˆ—é•¿åº¦ä¸Šè®¡ç®—å®ƒéœ€è¦O(BLDN)çš„æ—¶é—´å’Œå†…å­˜(the total hidden state has dimension ğ·ğ‘ per input, and computing it over the sequence length requires ğ‘‚(ğµğ¿ğ·ğ‘) time and memory)

3.1.1.3 mambaï¼šä»S4åˆ°S6çš„ç®—æ³•å˜åŒ–æµç¨‹
æœ€åï¼Œåœ¨Mamabaä¸­ï¼Œä½œè€…è®©BçŸ©é˜µã€CçŸ©é˜µã€âˆ†æˆä¸ºè¾“å…¥çš„å‡½æ•°ï¼Œè®©æ¨¡å‹èƒ½å¤Ÿæ ¹æ®è¾“å…¥å†…å®¹è‡ªé€‚åº”åœ°è°ƒæ•´å…¶è¡Œä¸º

![image](https://github.com/icey-zhang/notebook/assets/54712081/e97a475b-5198-47ab-bedb-8ddf4765e51e)

1.ä»S4åˆ°S6çš„è¿‡ç¨‹ä¸­
\rightarrow  å½±å“è¾“å…¥çš„BçŸ©é˜µã€å½±å“çŠ¶æ€çš„CçŸ©é˜µçš„å¤§å°ä»åŸæ¥çš„(D,N)ã€Œå‰é¢è¯´äº†ï¼ŒDæŒ‡çš„æ˜¯è¾“å…¥å‘é‡çš„ç»´åº¦ï¼Œæ¯”å¦‚ä¸€ä¸ªé¢œè‰²çš„å˜é‡ä¸€èˆ¬æœ‰R G Bä¸‰ä¸ªç»´åº¦ï¼ŒNæŒ‡SSMçš„éšè—å±‚ç»´åº¦hidden dimensionï¼Œå½“ç„¶ ä¸€èˆ¬è®¾çš„æ¯”è¾ƒå°ï¼Œè¿œå°äºL ã€

![image](https://github.com/icey-zhang/notebook/assets/54712081/52d803b2-6ee9-4e69-a41f-f7c1f09dae1d)

å˜æˆäº†(B,L,N)ã€Œè¿™ä¸‰ä¸ªå‚æ•°åˆ†åˆ«å¯¹åº”batch sizeã€sequence lengthã€hidden state sizeã€

![image](https://github.com/icey-zhang/notebook/assets/54712081/c71fd8d3-e0ac-4e8c-b859-fa5c4d9aacd7)

  ä¸”çš„å¤§å°ç”±åŸæ¥çš„Då˜æˆäº†(B,L,D)ï¼Œæ„å‘³ç€å¯¹äºä¸€ä¸ª batch é‡Œçš„ æ¯ä¸ª token (æ€»å…±æœ‰ BxL ä¸ª)éƒ½æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„
ä¸”æ¯ä¸ªä½ç½®çš„çŸ©é˜µã€çŸ©é˜µã€éƒ½ä¸ç›¸åŒï¼Œè¿™æ„å‘³ç€å¯¹äºæ¯ä¸ªè¾“å…¥tokenï¼Œç°åœ¨éƒ½æœ‰ç‹¬ç‰¹ä¸åŒçš„çŸ©é˜µã€çŸ©é˜µï¼Œå¯ä»¥è§£å†³å†…å®¹æ„ŸçŸ¥é—®é¢˜

2.ç»´åº¦ä¸Šçš„å˜åŒ–å…·ä½“æ‰§è¡Œæ—¶æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå¥½åŠï¼Œé€šè¿‡

![image](https://github.com/icey-zhang/notebook/assets/54712081/b59f85d7-aa4d-4912-813c-ac0885f5771f)

æ¥é€ä¸€å°†B, C, âˆ†å˜æˆè¾“å…¥æ•°æ®ä¾èµ–åŒ–(data dependent)

å…¶ä¸­å¯¹äºçŸ©é˜µBã€Cçš„ä»£è¡¨æŠŠç»´çš„è¾“å…¥å‘é‡ç»è¿‡ä¸€ä¸ªçº¿æ€§å±‚æ˜ å°„åˆ°ç»´ï¼Œæœ‰ç‚¹ç±»ä¼¼ä»ä¹‹å‰çš„64 Ã— 3(N Ã— D)å˜æˆ10000 Ã— 64(L Ã— N)ï¼Œä¸è¿‡ è¯»åˆ°æ­¤å¤„çš„ä½ ï¼Œå¯æ›¾æƒ³ä¸ºä½•ä¸æ˜¯å˜æˆ10000 Ã— 64 Ã— 3(L Ã— N Ã— D)å‘¢ï¼Ÿ
ä¸€ä¸ªå¯èƒ½çš„åŸå› æ˜¯ï¼Œè€Œå’Œéƒ½æœ‰è¿™ä¸ªç»´åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€ç»ˆä¹Ÿä¼šå…·å¤‡è¿™ä¸ªç»´åº¦
è™½ç„¶æ²¡æœ‰å˜æˆdata dependentï¼Œä½†æ˜¯é€šè¿‡SSMçš„ç¦»æ•£åŒ–æ“ä½œä¹‹åï¼Œä¼šç»è¿‡outer productå˜æˆ(B, L, N, D)çš„data dependentå¼ é‡ï¼Œç®—æ˜¯ä»¥ä¸€ç§parameter efficientçš„æ–¹å¼æ¥è¾¾åˆ°data dependentçš„ç›®çš„
ä¸”æ¢ä¸ªè§’åº¦çœ‹ï¼Œç¦»æ•£åŒ–ä¹‹åï¼Œ çš„â€œè¾“å…¥æ•°æ®ä¾èµ–æ€§â€èƒ½å¤Ÿè®©æ•´ä½“çš„ä¸è¾“å…¥ç›¸å…³

å½“ç„¶ï¼Œåˆ°åº•æ•ˆæœå˜å¥½çš„æœ€å¤§åŸå› æ˜¯å“ªä¸€å—ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡åšä¸‹ç›¸å…³çš„å®éªŒï¼šGated Linear Attention Transformers with Hardware-Efficient Training

